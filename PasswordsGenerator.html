<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Secure Password Generator</title>
  <meta name="description" content="Create strong, unique passwords instantly without sending data online.">
  <meta name="keywords" content="Password Generator, Secure Password, Random Password, Password Creator">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #f4f7fa;
      --text-color: #1a3c34;
      --card-bg: #ffffff;
      --border-color: #e0e7eb;
      --accent-color: #0d9488;
      --accent-hover: #0b8276;
      --secondary-color: #1e3a8a;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      --transition: all 0.2s ease;
    }
    [data-theme="dark"] {
      --bg-color: #1f2a44;
      --text-color: #e2e8f0;
      --card-bg: #2d3748;
      --border-color: #4a5568;
      --accent-color: #2dd4bf;
      --accent-hover: #26a69a;
      --secondary-color: #60a5fa;
    }
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 24px;
      line-height: 1.6;
    }
    a {
      color: var(--accent-color);
      text-decoration: none;
      transition: var(--transition);
    }
    a:hover {
      color: var(--accent-hover);
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 0 16px;
    }
    #header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }
    #LogoText {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-color);
    }
    #LogoText sup {
      font-size: 14px;
      font-weight: 500;
      vertical-align: super;
    }
    #header-actions {
      display: flex;
      gap: 16px;
      font-size: 14px;
    }
    #oldver, #theme_toggle {
      cursor: pointer;
      color: var(--accent-color);
      transition: var(--transition);
    }
    #theme_toggle::before {
      content: '‚òÄÔ∏è';
      margin-right: 4px;
    }
    [data-theme="dark"] #theme_toggle::before {
      content: 'üåô';
    }
    #theme_toggle:hover, #oldver:hover {
      color: var(--accent-hover);
    }
    .card {
      background: var(--card-bg);
      padding: 24px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow);
      margin-bottom: 24px;
    }
    .option-label {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-color);
    }
    .option-control {
      margin-bottom: 16px;
    }
    .option-control label {
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .option-control input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--accent-color);
    }
    .option-control input[type="text"] {
      width: 100%;
      padding: 8px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--card-bg);
      color: var(--text-color);
      transition: var(--transition);
    }
    .option-control input[type="text"]:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 2px rgba(13, 148, 136, 0.2);
    }
    .option-control select {
      padding: 8px;
      font-size: 14px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--card-bg);
      color: var(--text-color);
      width: 120px;
      transition: var(--transition);
    }
    .option-control select:focus {
      outline: none;
      border-color: var(--accent-color);
    }
    #buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      margin-bottom: 24px;
    }
    .button {
      background: var(--accent-color);
      color: #fff;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 500;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: var(--transition);
      min-width: 140px;
    }
    .button:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }
    .button:disabled {
      background: #6b7280;
      cursor: not-allowed;
      transform: none;
    }
    #generate_warning {
      font-size: 12px;
      color: #ef4444;
      text-align: center;
      margin-top: 8px;
      display: none;
      width: 100%;
    }
    .custom-tooltip {
      display: none;
      position: absolute;
      background: var(--secondary-color);
      color: #fff;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      z-index: 1000;
    }
    #password-output {
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    #password-output.visible {
      opacity: 1;
    }
    .output-label {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .output-container {
      display: flex;
      align-items: stretch;
      width: 100%;
    }
    #line_num {
      width: 48px;
      text-align: right;
      padding-right: 12px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      color: var(--text-color);
      line-height: 22px;
      user-select: none;
    }
    .each_line {
      height: 22px;
      line-height: 22px;
      font-size: 14px;
      text-align: right;
    }
    #final_pass {
      flex: 1;
      min-height: 100px;
      resize: none;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 22px;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--card-bg);
      color: var(--text-color);
      transition: var(--transition);
    }
    #final_pass:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 2px rgba(13, 148, 136, 0.2);
    }
    #strength_indicator {
      margin-top: 12px;
      font-size: 14px;
      text-align: center;
    }
    .strength-weak {
      color: #ef4444;
    }
    .strength-moderate {
      color: #f59e0b;
    }
    .strength-strong {
      color: #10b981;
    }
    #loading {
      display: none;
      text-align: center;
      font-size: 14px;
      color: var(--text-color);
      margin-top: 12px;
    }
    #loading::before {
      content: '';
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid var(--text-color);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .warning-message {
      color: #ef4444;
      font-size: 12px;
      margin-top: 4px;
    }
    #scroll-top {
      font-size: 14px;
      color: var(--accent-color);
      cursor: pointer;
      text-align: center;
      margin: 24px 0;
      transition: var(--transition);
    }
    #scroll-top:hover {
      color: var(--accent-hover);
    }
    @media (max-width: 600px) {
      .container {
        padding: 0 12px;
      }
      .button {
        width: 100%;
        font-size: 14px;
        padding: 12px;
      }
      .option-control select {
        width: 100%;
      }
      #line_num {
        width: 40px;
      }
      .option-label, .output-label {
        font-size: 14px;
      }
      .option-control {
        font-size: 13px;
      }
    }
    @media (max-width: 400px) {
      #line_num {
        width: 32px;
      }
      .option-label, .output-label {
        font-size: 13px;
      }
      .option-control {
        font-size: 12px;
      }
    }
  </style>
</head>
<body onload="OpenOptions();">
  <div class="container">
    <div id="header">
      <div id="LogoText">Password Generator<sup>4.0</sup></div>
      <div id="header-actions">
        <span id="oldver" onclick="Go2Old();" tabindex="0" aria-label="View previous version">Previous Version</span>
        <span id="theme_toggle" onclick="toggleTheme();" tabindex="0" aria-label="Switch between light and dark mode">Switch Theme</span>
      </div>
    </div>

    <div id="sec_options" class="card">
      <div class="option-label">Password Length</div>
      <div class="option-control">
        <select id="pgLength" onchange="SaveOptions(false); validateSymbols();" aria-label="Choose password length">
          <optgroup label="Short">
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
            <option value="13">13</option>
            <option value="14">14</option>
            <option value="15">15</option>
          </optgroup>
          <optgroup label="Secure">
            <option value="16">16</option>
            <option value="17">17</option>
            <option value="18">18</option>
            <option value="19">19</option>
            <option value="20">20</option>
            <option value="21">21</option>
            <option value="22" selected>22</option>
            <option value="23">23</option>
            <option value="24">24</option>
            <option value="25">25</option>
            <option value="26">26</option>
            <option value="27">27</option>
            <option value="28">28</option>
            <option value="29">29</option>
            <option value="30">30</option>
            <option value="31">31</option>
            <option value="32">32</option>
            <option value="33">33</option>
            <option value="34">34</option>
            <option value="35">35</option>
            <option value="36">36</option>
            <option value="37">37</option>
            <option value="38">38</option>
            <option value="39">39</option>
            <option value="40">40</option>
            <option value="41">41</option>
            <option value="42">42</option>
            <option value="43">43</option>
            <option value="44">44</option>
            <option value="45">45</option>
            <option value="46">46</option>
            <option value="47">47</option>
            <option value="48">48</option>
            <option value="49">49</option>
            <option value="50">50</option>
          </optgroup>
        </select>
      </div>

      <div class="option-label">Number of Passwords</div>
      <div class="option-control">
        <select id="pgQuantity" onchange="SaveOptions(false);" aria-label="Choose number of passwords">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5" selected>5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10">10</option>
          <option value="15">15</option>
          <option value="20">20</option>
          <option value="50">50</option>
          <option value="100">100</option>
          <option value="200">200</option>
          <option value="500">500</option>
          <option value="1000">1000</option>
        </select>
      </div>

      <div class="option-label">Include Numbers</div>
      <div class="option-control">
        <label><input type="checkbox" id="Numbers" onclick="SaveOptions(false); validateSymbols();" aria-label="Include numbers in passwords">Add digits (e.g., 123)</label>
      </div>

      <div class="option-label">Include Lowercase Letters</div>
      <div class="option-control">
        <label><input type="checkbox" id="Lowercase" onclick="SaveOptions(false); validateSymbols();" aria-label="Include lowercase letters in passwords">Add lowercase (e.g., abc)</label>
      </div>

      <div class="option-label">Include Uppercase Letters</div>
      <div class="option-control">
        <label><input type="checkbox" id="Uppercase" onclick="SaveOptions(false); validateSymbols();" aria-label="Include uppercase letters in passwords">Add uppercase (e.g., ABC)</label>
      </div>

      <div class="option-label">Include Symbols</div>
      <div class="option-control">
        <label><input type="checkbox" id="Symbols" onclick="SaveOptions(false); validateSymbols();" aria-label="Include symbols in passwords">Add symbols</label>
        <input id="CustomizeSymbols" type="text" value="!&quot;#$%&amp;'()*+,-./:;<=>?@[\]^_`{|}~" oninput="SaveOptions(false); validateSymbols();" aria-label="Enter custom symbols for passwords">
        <div id="symbols_warning" class="warning-message"></div>
      </div>

      <div class="option-label">Start with a Letter</div>
      <div class="option-control">
        <label><input type="checkbox" id="BeginWithC" onclick="SaveOptions(false);" aria-label="Start passwords with a letter">Begin with a letter (not a number or symbol)</label>
      </div>

      <div class="option-label">Avoid Similar Characters</div>
      <div class="option-control">
        <label><input type="checkbox" id="Nosimilar" onclick="SaveOptions(false); validateSymbols();" aria-label="Avoid similar characters">Exclude similar characters (e.g., i, l, 1, O, 0)</label>
      </div>

      <div class="option-label">Unique Characters Only</div>
      <div class="option-control">
        <label><input type="checkbox" id="AllUniqueC" onclick="SaveOptions(false); validateSymbols();" aria-label="Use each character only once">Use each character only once</label>
      </div>

      <div class="option-label">No Sequential Characters</div>
      <div class="option-control">
        <label><input type="checkbox" id="NoSeqC" onclick="SaveOptions(false);" aria-label="Avoid sequential characters">Avoid sequences (e.g., abc, 123)</label>
      </div>

      <div class="option-label">Auto-Generate on Load</div>
      <div class="option-control">
        <label><input type="checkbox" id="AutoMake" onclick="SaveOptions(false);" aria-label="Generate passwords on page load">Create passwords automatically on page load</label>
      </div>

      <div class="option-label">Save Settings</div>
      <div class="option-control">
        <label><input type="checkbox" id="SaveSettings" onclick="SaveOptions(true); updateSaveWarning();" aria-label="Save settings to cookies">Store settings in cookies</label>
        <div id="save_warning" class="warning-message"></div>
      </div>
    </div>

    <div id="buttons">
      <div class="button GenerateBtn" onclick="doWork();" tabindex="0" aria-label="Create new passwords">Create Passwords</div>
      <div id="generate_warning"></div>
      <div class="button ResetBtn" onclick="resetPasswords();" tabindex="0" aria-label="Clear all passwords">Clear Passwords</div>
      <div class="button ProxyBtn" id="CopyOne" onclick="OnCopy2();" tabindex="0" aria-label="Copy the first password">Copy First Password</div>
      <div id="tooltip2" class="custom-tooltip">Copied!</div>
      <div class="button ProxyBtn" onclick="OnCopy();" tabindex="0" aria-label="Copy all passwords">Copy All</div>
      <div id="tooltip1" class="custom-tooltip">All copied!</div>
    </div>

    <div id="password-output" class="card">
      <div class="output-label">Generated Passwords</div>
      <div class="output-container">
        <div id="line_num"></div>
        <textarea spellcheck="false" id="final_pass" onkeypress="if(event.key === 'Enter') doWork();" aria-label="Generated passwords"></textarea>
      </div>
      <div id="strength_indicator" aria-live="polite"></div>
      <div id="loading">Generating...</div>
    </div>

    <div id="scroll-top" onclick="scroll2top();" tabindex="0" aria-label="Scroll to top">Back to Top</div>
  </div>

  <script>
    var strArray = [];
    var nCurPWD = 0;
    var bWaiting = 0;
    var bBreak = 0;
    var nNum = 0;
    var nVer = 2;

    function $(id) {
      return document.getElementById(id);
    }

    function SelectAll(id) {
      const element = $(id);
      if (element) {
        element.focus();
        element.select();
      }
    }

    function scroll2top() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function OnCopy() {
      const copyText = $("final_pass");
      if (!copyText) return;
      copyText.select();
      copyText.setSelectionRange(0, 999999);
      try {
        document.execCommand("copy");
        $("tooltip1").style.display = "inline";
        setTimeout(() => {
          $("tooltip1").style.display = "none";
        }, 1000);
      } catch (e) {
        showError("Couldn‚Äôt copy all passwords!");
      }
    }

    function OnCopy2() {
      if (bWaiting || nCurPWD >= strArray.length) return;
      bWaiting = 1;
      try {
        navigator.clipboard.writeText(strArray[nCurPWD]).then(() => {
          $("tooltip2").style.display = "inline";
          setTimeout(() => {
            $("tooltip2").style.display = "none";
            ChangeBtnTitle();
          }, 1000);
        }).catch(() => {
          const textarea = document.createElement("textarea");
          textarea.value = strArray[nCurPWD];
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand("copy");
          document.body.removeChild(textarea);
          $("tooltip2").style.display = "inline";
          setTimeout(() => {
            $("tooltip2").style.display = "none";
            ChangeBtnTitle();
          }, 1000);
        });
      } catch (e) {
        showError("Couldn‚Äôt copy password!");
      }
    }

    function ChangeBtnTitle() {
      const nQuantity = nNum;
      const copyOne = $("CopyOne");
      if (!copyOne) return;
      if (nCurPWD < nQuantity - 1) {
        nCurPWD++;
        const nIndex = nCurPWD + 1;
        copyOne.innerHTML = nCurPWD === 1 ? "Copy Second Password" : nCurPWD === 2 ? "Copy Third Password" : `Copy Password ${nIndex}`;
      } else {
        nCurPWD = 0;
        copyOne.innerHTML = "Copy First Password";
      }
      bWaiting = 0;
    }

    function resetPasswords() {
      strArray = [];
      nCurPWD = 0;
      nNum = 0;
      const finalPass = $("final_pass");
      const lineNum = $("line_num");
      const copyOne = $("CopyOne");
      const strengthIndicator = $("strength_indicator");
      const passwordOutput = $("password-output");
      if (finalPass) finalPass.value = "";
      if (lineNum) lineNum.innerHTML = "";
      if (finalPass) finalPass.style.height = "100px";
      if (lineNum) lineNum.style.height = "100px";
      if (copyOne) copyOne.innerHTML = "Copy First Password";
      if (strengthIndicator) strengthIndicator.innerHTML = "";
      if (passwordOutput) passwordOutput.classList.remove("visible");
      const existingError = $("password-output")?.querySelector(".error-message");
      if (existingError) existingError.remove();
    }

    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute("data-theme") || "light";
      const newTheme = currentTheme === "light" ? "dark" : "light";
      document.documentElement.setAttribute("data-theme", newTheme);
      const themeToggle = $("theme_toggle");
      if (themeToggle) themeToggle.innerText = "Switch Theme";
      if ($("SaveSettings")?.checked) {
        setCookie("theme", newTheme, 60);
      }
    }

    function auto_grow(element) {
      if (!element) return;
      element.style.height = "100px";
      element.style.height = (element.scrollHeight) + "px";
      const lineNum = $("line_num");
      if (lineNum) lineNum.style.height = element.style.height;
    }

    function calculatePasswordStrength(password) {
      let strength = 0;
      const length = password.length;
      const hasUpper = /[A-Z]/.test(password);
      const hasLower = /[a-z]/.test(password);
      const hasNumbers = /[0-9]/.test(password);
      const hasSymbols = /[^a-zA-Z0-9]/.test(password);

      const commonPasswords = ["password", "qwerty", "123456", "admin"];
      if (commonPasswords.some(word => password.toLowerCase().includes(word))) {
        return { text: "Weak (Common word detected)", class: "strength-weak" };
      }

      if (length >= 16) strength += 2;
      else if (length >= 12) strength += 1;
      if (hasUpper) strength += 1;
      if (hasLower) strength += 1;
      if (hasNumbers) strength += 1;
      if (hasSymbols) strength += 1;

      const charSetSize = (hasLower ? 26 : 0) + (hasUpper ? 26 : 0) + (hasNumbers ? 10 : 0) + (hasSymbols ? 32 : 0);
      if (charSetSize > 0) {
        const entropy = Math.log2(Math.pow(charSetSize, length));
        if (entropy > 80) strength += 2;
        else if (entropy > 50) strength += 1;
      }

      if (strength >= 5) return { text: "Strong", class: "strength-strong" };
      if (strength >= 3) return { text: "Moderate", class: "strength-moderate" };
      return { text: "Weak", class: "strength-weak" };
    }

    function updateStrengthIndicator() {
      const strengthIndicator = $("strength_indicator");
      if (!strengthIndicator) return;
      if (strArray.length === 0) {
        strengthIndicator.innerHTML = "";
        return;
      }
      const strength = calculatePasswordStrength(strArray[0]);
      strengthIndicator.innerHTML = `Strength: <span class="${strength.class}">${strength.text}</span>`;
    }

    function validateSymbols() {
      const symbols = $("CustomizeSymbols")?.value;
      const isSymbolsChecked = $("Symbols")?.checked;
      const isAllUnique = $("AllUniqueC")?.checked;
      const length = parseInt($("pgLength")?.value || "22");
      const generateBtn = document.querySelector(".GenerateBtn");
      const generateWarning = $("generate_warning");
      const symbolsWarning = $("symbols_warning");

      if (!generateBtn || !generateWarning || !symbolsWarning) {
        console.error("Missing DOM elements in validateSymbols");
        return;
      }

      let charSetSize = 0;
      if ($("Lowercase")?.checked) charSetSize += $("Nosimilar")?.checked ? 22 : 26;
      if ($("Uppercase")?.checked) charSetSize += $("Nosimilar")?.checked ? 22 : 26;
      if ($("Numbers")?.checked) charSetSize += $("Nosimilar")?.checked ? 8 : 10;
      if (isSymbolsChecked && symbols) charSetSize += symbols.length;

      let warning = "";
      if (isSymbolsChecked) {
        if (!symbols) {
          warning = "Custom symbols can‚Äôt be empty.";
        } else if (symbols.match(/\s/)) {
          warning = "Custom symbols can‚Äôt contain spaces.";
        } else if (isAllUnique && charSetSize < length) {
          warning = `Not enough unique characters (${charSetSize}) for length ${length}. Shorten length or disable unique characters.`;
        }
      } else if (isAllUnique && charSetSize < length) {
        warning = `Not enough unique characters (${charSetSize}) for length ${length}. Shorten length, add symbols, or disable unique characters.`;
      }
      symbolsWarning.textContent = warning;
      const isDisabled = !!warning;
      generateBtn.disabled = isDisabled;
      generateWarning.style.display = isDisabled ? "block" : "none";
      generateWarning.textContent = isDisabled ? "Adjust settings to enable password creation." : "";
      console.log(`validateSymbols: isDisabled=${isDisabled}, warning="${warning}"`);
    }

    function updateSaveWarning() {
      const saveWarning = $("save_warning");
      if (saveWarning) {
        saveWarning.textContent = $("SaveSettings")?.checked
          ? "Settings are stored in cookies, which aren‚Äôt encrypted."
          : "";
      }
    }

    function shuffleString(str) {
      const arr = str.split('');
      for (let i = arr.length - 1; i > 0; i--) {
        const j = crypto.getRandomValues(new Uint32Array(1))[0] % (i + 1);
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr.join('');
    }

    function InsertChar(szCharSet, nBufferLength, szBuffer) {
      const bAllUnique = $("AllUniqueC")?.checked;
      if (!bAllUnique) {
        const nPos = crypto.getRandomValues(new Uint32Array(1))[0] % szCharSet.length;
        const nInsertPos = crypto.getRandomValues(new Uint32Array(1))[0] % (nBufferLength + 1);
        return szBuffer.substring(0, nInsertPos) + szCharSet[nPos] + szBuffer.substring(nInsertPos);
      }

      if (!szCharSet) return szBuffer;
      const nPos = crypto.getRandomValues(new Uint32Array(1))[0] % szCharSet.length;
      const charToInsert = szCharSet[nPos];
      if (szBuffer.indexOf(charToInsert) === -1) {
        const nInsertPos = crypto.getRandomValues(new Uint32Array(1))[0] % (nBufferLength + 1);
        return szBuffer.substring(0, nInsertPos) + charToInsert + szBuffer.substring(nInsertPos);
      }
      return szBuffer;
    }

    function hasSequentialChars(str) {
      for (let j = 0; j < str.length - 1; j++) {
        const n1 = str.charCodeAt(j);
        const n2 = str.charCodeAt(j + 1);
        if (n2 - n1 === 1 && (
          (n1 >= 48 && n1 <= 56) || // Numbers 2-8
          (n1 >= 65 && n1 <= 89) || // Uppercase A-Y
          (n1 >= 97 && n1 <= 121)  // Lowercase a-y
        )) {
          return true;
        }
      }
      return false;
    }

    function GeneratePassword(nLength, bNosimilar, bLowercase, bUppercase, bNumbers, bSymbols) {
      var szLower = "abcdefghjkmnpqrstuvwxyz";
      var szUpper = "ABCDEFGHJKLMNPQRSTUVWXYZ";
      var szNumber = "23456789";
      var szSymbols = bSymbols ? $("CustomizeSymbols")?.value.replace('|', '') : "";

      if (!bNosimilar) {
        szLower += "ilo";
        szUpper += "IO";
        szNumber += "01";
      }

      var szAll = "";
      var nSetNumber = 0;
      if (bLowercase) { szAll += szLower; nSetNumber++; }
      if (bUppercase) { szAll += szUpper; nSetNumber++; }
      if (bNumbers) { szAll += szNumber; nSetNumber++; }
      if (bSymbols) { szAll += szSymbols; nSetNumber++; }

      if (nSetNumber === 0) {
        return "Select at least one character type (numbers, lowercase, uppercase, or symbols).";
      }

      const bAllUnique = $("AllUniqueC")?.checked;
      if (bAllUnique && szAll.length < nLength) {
        return `Not enough unique characters. Shorten length to ${szAll.length} or disable unique characters.`;
      }

      if ($("BeginWithC")?.checked && !bLowercase && !bUppercase) {
        return "Select lowercase or uppercase to start with a letter.";
      }

      var szBuffer = "";
      if (bAllUnique) {
        szBuffer = shuffleString(szAll).slice(0, nLength);
      } else {
        for (let i = 0; i < nLength; i++) {
          const nPos = crypto.getRandomValues(new Uint32Array(1))[0] % szAll.length;
          szBuffer += szAll[nPos];
        }
      }

      let nBufferLength = szBuffer.length;
      if (bUppercase && !/[A-Z]/.test(szBuffer)) {
        szBuffer = InsertChar(szUpper, nBufferLength, szBuffer);
        nBufferLength++;
      }
      if (bLowercase && !/[a-z]/.test(szBuffer)) {
        szBuffer = InsertChar(szLower, nBufferLength, szBuffer);
        nBufferLength++;
      }
      if (bNumbers && !/[0-9]/.test(szBuffer)) {
        szBuffer = InsertChar(szNumber, nBufferLength, szBuffer);
        nBufferLength++;
      }
      if (bSymbols && !/[^a-zA-Z0-9]/.test(szBuffer)) {
        szBuffer = InsertChar(szSymbols, nBufferLength, szBuffer);
        nBufferLength++;
      }

      if (szBuffer.length > nLength) {
        szBuffer = szBuffer.slice(0, nLength);
      }

      if ($("NoSeqC")?.checked && hasSequentialChars(szBuffer)) {
        return "Seq";
      }
      if ($("BeginWithC")?.checked && !/^[a-zA-Z]/.test(szBuffer)) {
        return "NoC";
      }

      const commonPasswords = ["password", "qwerty", "123456", "admin"];
      if (commonPasswords.some(word => szBuffer.toLowerCase().includes(word))) {
        return "Common";
      }

      return szBuffer;
    }

    function doWork() {
      console.log("doWork called");
      const generateBtn = document.querySelector(".GenerateBtn");
      const loading = $("loading");
      const passwordOutput = $("password-output");
      if (!generateBtn || !loading || !passwordOutput) {
        console.error("Missing GenerateBtn, loading, or password-output element in doWork");
        return;
      }
      if (generateBtn.disabled) return;
      generateBtn.disabled = true;
      loading.style.display = "block";
      bBreak = 0;
      const strLength = parseInt($("pgLength")?.value || "22");
      const bNosimilar = $("Nosimilar")?.checked ? 1 : 0;
      const bSymbols = $("Symbols")?.checked ? 1 : 0;
      const bLowercase = $("Lowercase")?.checked ? 1 : 0;
      const bUppercase = $("Uppercase")?.checked ? 1 : 0;
      const bNumbers = $("Numbers")?.checked ? 1 : 0;
      const nQuantity = Math.min(parseInt($("pgQuantity")?.value || "5"), 1000);

      strArray = [];
      const maxAttempts = 50;
      for (let i = 0; i < nQuantity; i++) {
        let szPass = "";
        let attempts = 0;
        while (szPass.length < strLength && attempts < maxAttempts) {
          szPass = GeneratePassword(strLength, bNosimilar, bLowercase, bUppercase, bNumbers, bSymbols);
          if (szPass.includes("Select at least") || szPass.includes("Not enough") || szPass.includes("Select lowercase")) {
            showError(szPass);
            loading.style.display = "none";
            generateBtn.disabled = false;
            return;
          }
          attempts++;
        }
        if (attempts >= maxAttempts || szPass === "Seq" || szPass === "NoC" || szPass === "Common") {
          showError("Couldn‚Äôt create password with these settings. Try shortening length or disabling sequence/unique character options.");
          loading.style.display = "none";
          generateBtn.disabled = false;
          return;
        }
        strArray[i] = szPass;
      }

      const finalPass = $("final_pass");
      const lineNum = $("line_num");
      const copyOne = $("CopyOne");
      if (finalPass) finalPass.value = strArray.join("\n");
      if (lineNum) {
        const numberOfLines = nQuantity;
        let strLineNum = "";
        for (let iLoop = 1; iLoop <= numberOfLines; iLoop++) {
          strLineNum += `<div id="eell${iLoop}" class="each_line">${iLoop}</div>`;
        }
        lineNum.innerHTML = strLineNum;
        lineNum.style.height = (numberOfLines * 22 + 10) + "px";
      }
      if (finalPass) finalPass.style.height = (nQuantity * 22 + 10) + "px";
      if (copyOne) copyOne.innerHTML = "Copy First Password";
      nCurPWD = 0;
      nNum = nQuantity;
      if (finalPass) auto_grow(finalPass);
      updateStrengthIndicator();
      passwordOutput.classList.add("visible");
      loading.style.display = "none";
      generateBtn.disabled = false;
    }

    function showError(message) {
      const secPassword = $("password-output");
      if (!secPassword) return;
      const existingError = secPassword.querySelector(".error-message");
      if (existingError) existingError.remove();
      const errorDiv = document.createElement("div");
      errorDiv.className = "error-message";
      errorDiv.setAttribute("role", "alert");
      errorDiv.textContent = message;
      secPassword.prepend(errorDiv);
      setTimeout(() => errorDiv.remove(), 5000);
    }

    function getCookie(c_name) {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const x = cookies[i].substr(0, cookies[i].indexOf("=")).trim();
        const y = cookies[i].substr(cookies[i].indexOf("=") + 1);
        if (x === c_name) {
          return unescape(y);
        }
      }
      return null;
    }

    function setCookie(c_name, value, exdays) {
      const exdate = new Date();
      exdate.setDate(exdate.getDate() + exdays);
      const c_value = escape(value) + (exdays == null ? "" : "; expires=" + exdate.toUTCString());
      document.cookie = c_name + "=" + c_value;
    }

    function deleteAllCookies() {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i];
        const eqPos = cookie.indexOf("=");
        const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
        document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT";
      }
    }

    function OpenAOption(opt_name) {
      const defaults = {
        Symbols: true,
        Lowercase: true,
        Uppercase: true,
        Numbers: true,
        Nosimilar: true,
        BeginWithC: true,
        AllUniqueC: true,
        NoSeqC: true,
        AutoMake: true,
        SaveSettings: false
      };
      const element = $(opt_name);
      if (element) {
        const bValue = getCookie(opt_name);
        element.checked = bValue !== null ? bValue === "true" : defaults[opt_name];
      }
    }

    function SaveAOption(opt_name, ndays) {
      const element = $(opt_name);
      if (element) {
        const bValue = element.checked;
        setCookie(opt_name, bValue, ndays);
      }
    }

    function OpenOptions() {
      OpenAOption("Symbols");
      OpenAOption("Lowercase");
      OpenAOption("Uppercase");
      OpenAOption("Numbers");
      OpenAOption("Nosimilar");
      OpenAOption("BeginWithC");
      OpenAOption("AllUniqueC");
      OpenAOption("NoSeqC");
      OpenAOption("AutoMake");
      OpenAOption("SaveSettings");

      const pgLength = $("pgLength");
      if (pgLength) pgLength.value = getCookie("pgLength") || "22";

      const pgQuantity = $("pgQuantity");
      if (pgQuantity) pgQuantity.value = getCookie("pgQuantity") || "5";

      const defaultSymbols = "!\"#$%&'()*+,-./:;<=>?@[]^_`{|}~";
      const customizeSymbols = $("CustomizeSymbols");
      if (customizeSymbols) {
        let strCustomizeSymbols = getCookie("CustomizeSymbols");
        if (!strCustomizeSymbols || strCustomizeSymbols.match(/\s/) || ($("Symbols")?.checked && !strCustomizeSymbols)) {
          strCustomizeSymbols = defaultSymbols;
          if ($("SaveSettings")?.checked) {
            setCookie("CustomizeSymbols", defaultSymbols, 60);
          }
        }
        customizeSymbols.value = strCustomizeSymbols;
      }

      const theme = getCookie("theme") || "light";
      document.documentElement.setAttribute("data-theme", theme);
      const themeToggle = $("theme_toggle");
      if (themeToggle) themeToggle.innerText = "Switch Theme";

      updateSaveWarning();
      validateSymbols();
      if ($("AutoMake")?.checked) {
        doWork();
      }
    }

    function SaveOptions(bErase) {
      const bSave = $("SaveSettings")?.checked;
      const ndays = 60;
      if (bSave) {
        SaveAOption("Symbols", ndays);
        SaveAOption("Lowercase", ndays);
        SaveAOption("Uppercase", ndays);
        SaveAOption("Numbers", ndays);
        SaveAOption("Nosimilar", ndays);
        SaveAOption("BeginWithC", ndays);
        SaveAOption("AllUniqueC", ndays);
        SaveAOption("NoSeqC", ndays);
        SaveAOption("AutoMake", ndays);
        SaveAOption("SaveSettings", ndays);
        if ($("CustomizeSymbols")) setCookie("CustomizeSymbols", $("CustomizeSymbols").value, ndays);
        if ($("pgLength")) setCookie("pgLength", $("pgLength").value, ndays);
        if ($("pgQuantity")) setCookie("pgQuantity", $("pgQuantity").value, ndays);
        setCookie("theme", document.documentElement.getAttribute("data-theme"), ndays);
      } else if (bErase) {
        deleteAllCookies();
      }
      updateSaveWarning();
    }

    function Go2Old() {
      window.location.assign("https://passwordsgenerator.net/old.php");
    }
  </script>
</body>
</html>